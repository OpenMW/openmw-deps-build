# openmw-deps-build

This is a repository to host CI jobs to build dependencies for OpenMW via vcpkg to be cached as binary artifacts at [https://gitlab.com/OpenMW/openmw-deps](https://gitlab.com/OpenMW/openmw-deps).

Jobs start automatically on push to master and automatically push archived artifacts to another git repository.

[Vcpkg has system requirements](https://learn.microsoft.com/en-us/vcpkg/concepts/supported-hosts)

## Secret Setup in CI for Testing

You can test the repo is working on your own fork using a deploy key and a gpg key you generate.

To make this work properly multiple [**secrets**](https://docs.github.com/en/actions/security-guides/using-secrets-in-github-actions) have to be configured:

* `SSH_PRIVATE_KEY` with private SSH key allowed to push changes to repository specified via `PUSH_URL` variable (e.g. generated by `ssh-keygen`).
  * You should use a deploy key setup on your fork of [https://gitlab.com/OpenMW/openmw-dep](https://gitlab.com/OpenMW/openmw-dep)
* `GPG_PRIVATE_KEY` with private GPG key to sign commits with GPG signature (e.g. generated with `gpg --full-generate-key`).
* `GPG_PRIVATE_KEY_PASSPHRASE` a passphrase for the `GPG_PRIVATE_KEY` to make it possible to use the GPG key (e.g. the value used during `gpg --full-generate-key`).
  * You can generate a gpg key with the git author information used in CI. It does not need to be associated with any account.

Also the following [**variable**](https://docs.github.com/en/actions/learn-github-actions/variables) has to be set:

* `PUSH_URL` with target SSH-based URL for `git push` command (e.g. `git@gitlab.com:OpenMW/openmw-deps.git` or your fork).

Any pushes should create a branch/commit on the openmw-dep repo. However, the manifest file links will not work. You will need to create a tag/release for that to work.

## ARM64 MacOS Setup

You need to install the following: `brew install autoconf autoconf-archive automake`

1. `vcpkg install --overlay-ports=ports --overlay-triplets=triplets --triplet arm64-osx-dynamic --host-triplet arm64-osx-dynamic`
1. `vcpkg export --x-all-installed --raw --output vcpkg-macos-test --output-dir DIRECTORY`

To test with OpenMW, you will need to change the `DEPENDENCIES_ROOT` on the top of the `before_script.macos.sh` in OpenMW file to:

```
DEPENDENCIES_ROOT_PATH="/DIRECTORY/vcpkg-macos-test"
```
